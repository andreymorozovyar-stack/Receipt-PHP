<?php

/**
 * Простой тест парсера без зависимостей
 * 
 * ВАЖНО: Это пример теста. Скопируйте в test_parser_simple.php и используйте реальные данные для тестирования.
 */

// Простой автозагрузчик
spl_autoload_register(function ($class) {
    $prefix = 'ReceiptRecognition\\';
    $base_dir = __DIR__ . '/../src/';
    
    $len = strlen($prefix);
    if (strncmp($prefix, $class, $len) !== 0) {
        return;
    }
    
    $relative_class = substr($class, $len);
    $file = $base_dir . str_replace('\\', '/', $relative_class) . '.php';
    
    if (file_exists($file)) {
        require $file;
    }
});

use ReceiptRecognition\Parser;

$parser = new Parser();

echo "=== Тестирование парсера чеков ===\n\n";

// Тест 1: Базовый пример текста чека
// ЗАМЕНИТЕ на реальные данные из вашего чека
$testText1 = "Чек <НОМЕР_ЧЕКА>
<ДАТА>
<ВРЕМЯ>
<ФИО_ПРОДАВЦА>
Наименование
Сумма
<НАИМЕНОВАНИЕ_УСЛУГИ>
<СУММА> ₽
Итого:
<ИТОГОВАЯ_СУММА> ₽
Режим HO
<РЕЖИМ_НАЛОГООБЛОЖЕНИЯ>
ИНН
<ИНН_ПРОДАВЦА>
Чек сформировал
<ФОРМИРОВАТЕЛЬ>
ИНН
<ИНН_ФОРМИРОВАТЕЛЯ>
Покупатель;
ИНН; <ИНН_ПОКУПАТЕЛЯ>";

echo "Тест 1: Базовый пример\n";
echo "Входной текст (первые 200 символов): " . mb_substr($testText1, 0, 200) . "...\n\n";
$result1 = $parser->parseReceiptText($testText1);

echo "Результат:\n";
echo json_encode($result1, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . "\n\n";

// Проверка результатов
// ОБНОВИТЕ значения проверок под ваши реальные данные
$checks = [
    'receipt_number' => $result1['receipt_number'] !== null,
    'date' => $result1['date'] !== null,
    'time' => $result1['time'] !== null,
    'seller_name' => $result1['seller_name'] !== null,
    'seller_inn' => $result1['seller_inn'] !== null,
    'buyer_inn' => $result1['buyer_inn'] !== null,
    'services' => !empty($result1['services']),
    'total_amount' => $result1['total_amount'] !== null,
    'tax_mode' => $result1['tax_mode'] !== null,
    'check_former' => $result1['check_former'] !== null,
    'check_former_inn' => $result1['check_former_inn'] !== null,
];

echo "Проверки:\n";
$passed = 0;
$total = count($checks);
foreach ($checks as $field => $passedCheck) {
    $status = $passedCheck ? "✓" : "✗";
    $value = $result1[$field] ?? 'null';
    if (is_array($value)) {
        $value = count($value) . ' элементов';
    }
    echo "  $status $field: " . (is_string($value) && mb_strlen($value) > 50 ? mb_substr($value, 0, 50) . '...' : $value) . "\n";
    if ($passedCheck) $passed++;
}

echo "\nПройдено: $passed/$total\n";

if ($passed === $total) {
    echo "✓ Все тесты пройдены успешно!\n";
} else {
    echo "⚠ Некоторые тесты не пройдены\n";
}

// Тест 2: Минимальный текст
echo "\n---\n\nТест 2: Минимальный текст\n";
$testText2 = "Чек ABC123
Итого: 100.50 руб";
$result2 = $parser->parseReceiptText($testText2);
echo "Результат:\n";
echo json_encode($result2, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT) . "\n";

// Тест 3: Пустой текст
echo "\n---\n\nТест 3: Пустой текст\n";
$result3 = $parser->parseReceiptText("");
echo "Результат:\n";
echo json_encode($result3, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT) . "\n";

echo "\n=== Тестирование завершено ===\n";
